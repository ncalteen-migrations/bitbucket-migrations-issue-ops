name: Shared Bitbucket Server Export

on:
  workflow_call:
    inputs:
      migration-guid:
        default: migration-archive-${{ github.event.issue.number }}
        type: string
      setup-ruby:
        default: true
        type: boolean
    secrets:
      BITBUCKET_API_PRIVATE_TOKEN:
        required: true
      BITBUCKET_SERVER_URL:
        required: true

jobs:
  export:
    name: Export
    runs-on: ubuntu-latest

    if:
      github.event_name == 'issue_comment' &&
      (startsWith(github.event.comment.body, '/run-dry-run-migration') ||
      startsWith(github.event.comment.body, '/run-production-migration'))

    env:
      MIGRATION_GUID: ${{ inputs.migration-guid }}
      BITBUCKET_API_PRIVATE_TOKEN: ${{ secrets.BITBUCKET_API_PRIVATE_TOKEN }}
      BITBUCKET_SERVER_URL: ${{ secrets.BITBUCKET_SERVER_URL }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Update issue with running status
        uses: actions/github-script@v6
        with:
          script: |
            const body = `:hourglass_flowing_sand: Running migration. [View workflow run for details](${context.payload.repository.html_url}/actions/runs/${context.runId})`

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            })

      - name: Parse repositories from issue body
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs')
            const parsedIssueBody = require('./.github/scripts/parse-issue-body.js')({context, core})

            fs.writeFileSync('repositories.txt', parsedIssueBody.repositories.trim())

      - name: Log repositories to migrate
        run: cat repositories.txt

      - name: Set up Ruby
        if: ${{ inputs.setup-ruby }}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 2.6.4

      - name: Bootstrap Bitbucket Server exporter
        working-directory: ./tools/bbs-exporter
        run: chmod +x ./script/bootstrap && ./script/bootstrap

      #- name: Output Bitbucket Server Exporter version
      #  working-directory: ./tools/bbs-exporter
      #  run: bundle exec exe/bbs-exporter --version

      - name: Export from Bitbucket Server
        working-directory: ./tools/bbs-exporter
        run: bbs-exporter -f repositories.txt -o ${MIGRATION_GUID}.tar.gz

      - name: Upload migration archive to GitHub Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.MIGRATION_GUID }}.tar.gz
          path: ${{ github.workspace }}/${{ env.MIGRATION_GUID }}.tar.gz
          if-no-files-found: error
          retention-days: 1

      - if: ${{ failure() }}
        name: Update issue with failed export
        uses: actions/github-script@v6
        with:
          script: |
            const body = `:no_entry: **Export failed.** [View workflow run for details](${context.payload.repository.html_url}/actions/runs/${context.runId})`

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            })

      - if: ${{ success() }}
        name: Update issue with successful export
        uses: actions/github-script@v6
        with:
          script: |
            const body = `:white_check_mark: **Export successful.** [View workflow run for details](${context.payload.repository.html_url}/actions/runs/${context.runId})`

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            })
